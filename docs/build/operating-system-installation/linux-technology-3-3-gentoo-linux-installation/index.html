<!DOCTYPE html>
<html
  lang="zh"
  dir="ltr"
  
><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">


<title>Gentoo Linux 物理机安装与配置 | Linux 安装教程 | 悦翎轩</title>

<meta name="generator" content="Hugo Eureka 0.9.3" />
<link rel="stylesheet" href="https://endlesspeak.github.io/css/eureka.min.3f9c102b2958d0308ef084ee682440b37aa0ca93912ed5c0980028307f924cfb413f8214a8ae653b7def936d6a1bc390.css">
<script defer src="https://endlesspeak.github.io/js/eureka.min.fa9a6bf6d7a50bb635b4cca7d2ba5cf3dfb095ae3798773f1328f7950028b48c17d06276594e1b5f244a25a6c969a705.js"></script>

















<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload"
  href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&amp;family=Noto&#43;Sans&#43;SC:wght@400;600;700&amp;family=Source&#43;Sans&#43;Pro:wght@400;600;700&amp;display=swap"
  as="style" onload="this.onload=null;this.rel='stylesheet'">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/styles/nnfx-light.min.css"
   media="print"
  onload="this.media='all';this.onload=null" crossorigin>
<script defer src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/highlight.min.js"
   crossorigin></script>
  <script defer src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/c.min.js"
     crossorigin></script>
  <script defer src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/cpp.min.js"
     crossorigin></script>
  <script defer src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/java.min.js"
     crossorigin></script>
  <script defer src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/python.min.js"
     crossorigin></script>
  <script defer src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/dart.min.js"
     crossorigin></script>
  <script defer src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/cmake.min.js"
     crossorigin></script>
  <script defer src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/rust.min.js"
     crossorigin></script>
<link rel="stylesheet" href="https://endlesspeak.github.io/css/highlightjs.min.2958991528e43eb6fc9b8c4f2b8e052f79c4010718e1d1e888a777620e9ee63021c2c57ec7417a3108019bb8c41943e6.css" media="print" onload="this.media='all';this.onload=null">


<script defer type="text/javascript" src="https://endlesspeak.github.io/js/fontawesome.min.15ca3da36d9676aa223d8be3b1f49c6d893c4e16cbfce12124e114e34b1f20e7f5eee796fba6948cfac4c6a9ae381fcd.js"></script>




<script defer src="https://cdn.jsdelivr.net/npm/mermaid@8.14.0/dist/mermaid.min.js" 
  integrity="sha384-atOyb0FxAgN9LyAc6PEf9BjgwLISyansgdH8/VXQH8p2o5vfrRgmGIJ2Sg22L0A0"  crossorigin></script>




<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>
  MathJax = {
    tex: {
      inlineMath: [["$", "$"],["\\(", "\\)"]],
    },
    displayMath: [
      ["$$", "$$"],
      ["\[\[", "\]\]"],
    ],
    svg: {
      fontCache: "global",
    },
  };
</script>
<link rel="icon" type="image/png" sizes="32x32" href="https://endlesspeak.github.io/images/avtar_huc2c209728b40c4588688df8c11b591ef_46235_32x32_fill_box_center_3.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://endlesspeak.github.io/images/avtar_huc2c209728b40c4588688df8c11b591ef_46235_180x180_fill_box_center_3.png">

<meta name="description"
  content="本文主要介绍了如何在物理机中安装Gentoo Linux。">
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
      "@type": "ListItem",
      "position": 1 ,
      "name":"Docs",
      "item":"https://endlesspeak.github.io/docs/"},{
      "@type": "ListItem",
      "position": 2 ,
      "name":"Docs",
      "item":"https://endlesspeak.github.io/docs/build/"},{
      "@type": "ListItem",
      "position": 3 ,
      "name":"Linux 安装教程",
      "item":"https://endlesspeak.github.io/docs/build/operating-system-installation/"},{
      "@type": "ListItem",
      "position": 4 ,
      "name":"Gentoo Linux 物理机安装与配置",
      "item":"https://endlesspeak.github.io/docs/build/operating-system-installation/linux-technology-3-3-gentoo-linux-installation/"}]
}
</script>



<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://endlesspeak.github.io/docs/build/operating-system-installation/linux-technology-3-3-gentoo-linux-installation/"
    },
    "headline": "Gentoo Linux 物理机安装与配置 | Linux 安装教程 | 悦翎轩","datePublished": "2022-08-18T00:00:00+00:00",
    "dateModified": "2022-08-18T00:00:00+00:00",
    "wordCount":  8685 ,
    "author": {
        "@type": "Person",
        "name": ["EndlessPeak"]
    },
    "publisher": {
        "@type": "Person",
        "name": "EndlessPeak",
        "logo": {
            "@type": "ImageObject",
            "url": "https://endlesspeak.github.io/images/avtar.png"
        }
        },
    "description": "本文主要介绍了如何在物理机中安装Gentoo Linux。"
}
</script><meta property="og:title" content="Gentoo Linux 物理机安装与配置 | Linux 安装教程 | 悦翎轩" />
<meta property="og:type" content="article" />


<meta property="og:image" content="https://endlesspeak.github.io/images/avtar.png">


<meta property="og:url" content="https://endlesspeak.github.io/docs/build/operating-system-installation/linux-technology-3-3-gentoo-linux-installation/" />



<meta property="og:description" content="本文主要介绍了如何在物理机中安装Gentoo Linux。" />



<meta property="og:locale" content="zh" />




<meta property="og:site_name" content="悦翎轩" />






<meta property="article:published_time" content="2022-08-18T00:00:00&#43;00:00" />


<meta property="article:modified_time" content="2022-08-18T00:00:00&#43;00:00" />



<meta property="article:section" content="docs" />





  <body class="flex min-h-screen flex-col">
    <header
      class="min-h-16 pl-scrollbar bg-secondary-bg fixed z-50 flex w-full items-center shadow-sm"
    >
      <div class="mx-auto w-full max-w-screen-xl"><script>
    let storageColorScheme = localStorage.getItem("lightDarkMode")
    if (((storageColorScheme == 'Auto' || storageColorScheme == null) && window.matchMedia("(prefers-color-scheme: dark)").matches) || storageColorScheme == "Dark") {
        document.getElementsByTagName('html')[0].classList.add('dark')
    }
</script>
<nav class="flex items-center justify-between flex-wrap px-4 py-4 md:py-0">
    <a href="/" class="me-6 text-primary-text text-xl font-bold">悦翎轩</a>
    <button id="navbar-btn" class="md:hidden flex items-center px-3 py-2" aria-label="Open Navbar">
        <i class="fas fa-bars"></i>
    </button>

    <div id="target"
        class="hidden block md:flex md:grow md:justify-between md:items-center w-full md:w-auto text-primary-text z-20">
        <div class="md:flex md:h-16 text-sm md:grow pb-4 md:pb-0 border-b md:border-b-0">
            <a href="/authors" class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2  border-transparent  me-4">关于</a>
            <a href="/posts/" class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2  border-transparent  me-4">文章</a>
            <a href="/docs/docs/" class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2  border-transparent  me-4">文档</a>
            <a href="/docs/build/" class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2  selected-menu-item  me-4">构建</a>
            <a href="/categories" class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2  border-transparent  me-4">分类</a>
            <a href="/tags" class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2  border-transparent  me-4">标签</a>
        </div>

        <div class="flex">
            <div class="relative pt-4 md:pt-0">
                <div class="cursor-pointer hover:text-eureka" id="lightDarkMode">
                    <i class="fas fa-adjust"></i>
                </div>
                <div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-30" id="is-open">
                </div>
                <div class="absolute flex flex-col start-0 md:start-auto end-auto md:end-0 hidden bg-secondary-bg w-48 rounded py-2 border border-tertiary-bg cursor-pointer z-40"
                    id='lightDarkOptions'>
                    <span class="px-4 py-1 hover:text-eureka" name="Light">浅色</span>
                    <span class="px-4 py-1 hover:text-eureka" name="Dark">深色</span>
                    <span class="px-4 py-1 hover:text-eureka" name="Auto">自动</span>
                </div>
            </div>
        </div>
    </div>

    <div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-0" id="is-open-mobile">
    </div>

</nav>
<script>
    
    let element = document.getElementById('lightDarkMode')
    if (storageColorScheme == null || storageColorScheme == 'Auto') {
        document.addEventListener('DOMContentLoaded', () => {
            window.matchMedia("(prefers-color-scheme: dark)").addEventListener('change', switchDarkMode)
        })
    } else if (storageColorScheme == "Light") {
        element.firstElementChild.classList.remove('fa-adjust')
        element.firstElementChild.setAttribute("data-icon", 'sun')
        element.firstElementChild.classList.add('fa-sun')
    } else if (storageColorScheme == "Dark") {
        element.firstElementChild.classList.remove('fa-adjust')
        element.firstElementChild.setAttribute("data-icon", 'moon')
        element.firstElementChild.classList.add('fa-moon')
    }

    document.addEventListener('DOMContentLoaded', () => {
        getcolorscheme();
        switchBurger();
    });
</script>
</div>
    </header>
    <main class="grow pt-16">
        <div class="pl-scrollbar">
          <div class="mx-auto w-full max-w-screen-2xl lg:px-4 xl:px-8">


<div class="lg:pt-12">
    <div class="flex flex-col md:flex-row bg-secondary-bg rounded">
        <div class="md:w-1/4 lg:w-1/5 border-e">
            <div class="sticky top-16 pt-6">
                










<div id="sidebar-title" class="md:hidden mx-4 px-2 pt-4 pb-2 md:border-b text-tertiary-text md:text-primary-text">
    <span class="font-semibold">目录</span>
    <i class='fas fa-caret-right ms-1'></i>
</div>

<div id="sidebar-toc"
    class="hidden md:block overflow-y-auto mx-6 md:mx-0 pe-6 pt-2 md:max-h-doc-sidebar bg-primary-bg md:bg-transparent">
    <div class="flex flex-wrap ms-4 -me-2 p-2 bg-secondary-bg md:bg-primary-bg rounded">
        <a class=" hover:text-eureka"
            href="https://endlesspeak.github.io/docs/build/operating-system-installation/">Linux 安装教程</a>
        
        
        


    </div>
    
<ul class="ps-6">
    
    
    
    <li class="py-2">
        <div class="">
            <a class=" hover:text-eureka"
                href="https://endlesspeak.github.io/docs/build/operating-system-installation/linux-technology-3-1-parrot-linux-installation/">Parrot Linux 物理机的安装、引导与配置</a>
        </div>
        
    </li>
    
    
    
    
    <li class="py-2">
        <div class="">
            <a class=" hover:text-eureka"
                href="https://endlesspeak.github.io/docs/build/operating-system-installation/linux-technology-3-2-arch-linux-installation/">Arch Linux 物理机的安装与引导</a>
        </div>
        
    </li>
    
    
    
    
    <li class="py-2">
        <div class="">
            <a class=" text-eureka  hover:text-eureka"
                href="https://endlesspeak.github.io/docs/build/operating-system-installation/linux-technology-3-3-gentoo-linux-installation/">Gentoo Linux 物理机安装与配置</a>
        </div>
        
    </li>
    
    
    
    
    <li class="py-2">
        <div class="">
            <a class=" hover:text-eureka"
                href="https://endlesspeak.github.io/docs/build/operating-system-installation/linux-technology-3-4-nixos-linux-installation/">NixOS Linux 物理机安装与配置</a>
        </div>
        
    </li>
    
    
</ul>

</div>





            </div>

        </div>
        <div class="w-full md:w-3/4 lg:w-4/5 pb-8 pt-2 md:pt-8">
            <div class="flex">
                <div class="w-full lg:w-3/4 px-6">
                    <article class="prose">
  <h1 class="mb-4">Gentoo Linux 物理机安装与配置</h1>

  <div
  class="text-tertiary-text not-prose mt-2 flex flex-row flex-wrap items-center"
>
  <div class="me-6 my-2">
    <i class="fas fa-calendar me-1"></i>
    <span
      >2022-08-18</span
    >
  </div>
  <div class="me-6 my-2">
    <i class="fas fa-clock me-1"></i>
    <span>18分钟阅读时长</span>
  </div>

  

  
</div>


  
  

  <h2 id="note">Note</h2>
<p>Gentoo Linux是一个快速、现代的元发行版，它的设计简洁、灵活。具有自由、高性能、开放和稳定等优点。</p>
<h3 id="motivation">Motivation</h3>
<ol>
<li>自由
高度自由的选择，用户可以选择自己想要的组件</li>
<li>性能
通过编译期优化和链接期优化获得更好的使用体验，更差的安装体验</li>
<li>开放
大部分软件均以源码的形式发布，编译和安装，不对用户隐藏细节</li>
<li>稳定
滚动更新，但是是在保证稳定的基础上，除非破坏，否则基本不会崩溃</li>
</ol>
<h3 id="reference-additional">Reference Additional</h3>
<ol>
<li>Gentoo Installtion ISO 并非不能使用
<ol>
<li><code>mount</code> 操作步骤确实比其他发行版更复杂</li>
<li><code>fstab</code> 可下载 gentoo 官方提供的 <code>genfstab</code> ，不必手动生成</li>
</ol>
</li>
<li>init 系统的选择
<ol>
<li>Systemd 是目前主流的 init 系统，相当多的发行版正在使用，这包括 <code>debian</code> , <code>redhat</code>, <code>arch</code>, <code>nixos</code> 等等。</li>
<li>openRC 是 Gentoo 官方推荐的 init 系统
<ol>
<li>优点是可移植（移植到 freeBSD 或其他 unix 系统上）</li>
<li>缺点是管理的内容没有 systemd 丰富，需要设置更多的内容。</li>
</ol>
</li>
</ol>
</li>
</ol>
<h3 id="requirement">Requirement</h3>
<ol>
<li>Hardware
由于绝大多数软件均需要通过源码编译，因此硬件不能过低。
我的配置是 Core I5-8250U,Mem 8GiB,Disk 120GiB</li>
<li>Psychological expectation
不可避免地，源码编译会消耗大量的时间和精力，优化软件亦然。
因此确保：
<ol>
<li>你是狂热的开源软件爱好者/Linux 爱好者；</li>
<li>编译和优化所消耗的时间在你的承受范围内。</li>
</ol>
</li>
</ol>
<h2 id="start">Start</h2>
<h3 id="network">Network</h3>
<p>Gentoo 从软件仓库下载所有软件的源码（当然，基本的安装和编译环境仍由 gentoo 提供）因此连接互联网是必须的步骤</p>
<ol>
<li>有线网
<code>dhcpcd</code> 即可联网，否则参见 <strong>Reference</strong> 中的详细步骤。
建议尽量使用有线网络而非无线网络，因为内核中可能没有无线网卡驱动。</li>
<li>无线网
<code>iw dev</code> 或者 <code>iwctl</code> 配置无线网络。
最推荐的是 <code>nmtui</code> ，该命令属于 <code>NetworkManager</code> 软件包。</li>
<li>测试网络
使用 <code>ping</code> 命令，注意该命令发送的是 ICMP 报文，只能确保存在本机到远端的物理通路，但是仍然有可能无法连接互联网。</li>
</ol>
<h3 id="preinstallation">PreInstallation</h3>
<h4 id="installation-media">Installation media</h4>
<p>安装介质的选择通常是 U 盘，特别地， <strong>镜像写入方式没有明确限制</strong> ，推荐使用 ISO 镜像。</p>
<ol>
<li>Linux 上可以选择 <code>DD</code> 镜像方式写入
<pre><code class="language-shell">dd if=&lt;iso文件&gt; of=/dev/&lt;device&gt; bs=1M status=progress
</code></pre>
</li>
<li>Windows 上可以选择 <code>Rufus</code> 或者 <code>UltraISO</code></li>
</ol>
<h4 id="user-account">User Account</h4>
<p>安装介质进入的 liveCD 系统通常不需要额外添加用户，但是如果需要使用额外的服务除外。</p>
<pre><code class="language-shell">passwd # 修改root用户密码
useradd -m -G wheel leesin # 添加用户，带有home目录，且在wheel用户组中
passwd leesin # 修改添加的账户的密码
</code></pre>
<p>由于 Gentoo Linux 的安全设置，设置的密码很可能因不够复杂而被系统拒绝，可以手动修改复杂程度规范，也可以在系统主机中设置 <code>use</code> 变量</p>
<pre><code class="language-shell">nano -w /etc/security/passwdqc.conf
</code></pre>
<p>说明：</p>
<ol>
<li>gentoo 的 livecd 默认只带有 nano</li>
<li>arch 的 livecd 带有 vim，因此使用 arch 的 livecd 安装 gentoo 是一个好选择</li>
</ol>
<h4 id="service">Service</h4>
<ol>
<li>安装时需要查看文档
<ol>
<li>切换到 <code>tty2</code> ，使用 root 或刚刚创建的用户登录。</li>
<li>使用 <code>links</code> ，访问 gentoo 的安装 wiki 。</li>
</ol>
</li>
<li>安装时需要 <code>SSH</code> 远程登录
<ol>
<li>编辑 <code>/etc/ssh/sshd_config</code> 确保 <code>PermitRootLogin yes</code></li>
<li><code>ss -ntlp</code> 查看 port 是否启用默认的 22 端口，也可以开启其他端口</li>
<li>IP 地址确认
<ol>
<li>如果是虚拟机，例如 VirtualBox：
<ol>
<li>依次点选 设置 端口转发，新增端口转发规则</li>
<li>主机端口只需要不和已有的端口冲突</li>
<li>子系统端口选择默认的 22，也可以设置其他的端口</li>
</ol>
</li>
<li>如果是物理机，则需要额外的一台计算机：
<ol>
<li>连接到同一局域网</li>
<li>系统主机通过 <code>ip address</code> 查看 IP 地址</li>
<li>工具主机通过该地址连接</li>
</ol>
</li>
</ol>
</li>
<li><code>SSH</code> 连接
假设 IP 地址为 192.168.2.1
<ol>
<li><code>ssh root@192.168.2.1/24</code></li>
<li><code>ssh -p 22 root@192.168.2.1/24</code></li>
</ol>
</li>
</ol>
</li>
</ol>
<h3 id="partition">Partition</h3>
<p>首先观察硬盘上所有的块设备。</p>
<pre><code class="language-shell">fdisk -l
lsblk
</code></pre>
<p>然后判断电脑的引导方式和分区表类型。
引导模式分为 BIOS 和 UEFI 两种；分区表类型分为 MBR 和 GPT 两种。</p>
<ol>
<li>
<p>Windows 下</p>
<ol>
<li>判断电脑的引导模式
在运行对话框中输入 <code>msinfo32</code> 在弹出的系统信息(或在控制面板 <em>/ 系统与安全</em> / 管理工具 / 系统信息)中寻找到 BIOS 模式项，观察是否是 UEFI。</li>
<li>判断磁盘的分区类型
右击我的电脑 / 管理 / 右击磁盘管理 / 属性，在弹出的对话框中会显示磁盘分区形式</li>
</ol>
</li>
<li>
<p>Linux 下
判断电脑的 BIOS 引导模式及分区类型</p>
<ol>
<li>法一，通过内核暴露的环境信息验证
<pre><code class="language-shell">ls /sys/firmware/efi/efivars
</code></pre>
</li>
<li>法二，通过磁盘上的分区格式验证
<pre><code class="language-shell">fdisk -l
</code></pre>
检查是否有 <code>EFI</code> 分区格式，是否有 gpt 字样。</li>
</ol>
</li>
</ol>
<h4 id="mbr">MBR</h4>
<p>什么?你居然还在用 <code>MBR</code> ，哦我的天哪，我建议你立刻停止这种行为，除非你愿意去看看官方 wiki!</p>
<h4 id="gpt">GPT</h4>
<p>一般地，分区需要指定至少 2 个挂载点，即 <code>/boot</code> 和 <code>/</code>
对于拥有一块固态硬盘，一块机械硬盘的电脑来说，挂载点通常如下：</p>
<table>
<thead>
<tr>
<th>挂载点</th>
<th>文件系统</th>
<th>挂载位置(块设备)</th>
<th>挂载用途</th>
<th>大小</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/</code></td>
<td>ext4</td>
<td>/dev/sda6</td>
<td>根分区 记录几乎所有的内容</td>
<td>120GiB</td>
</tr>
<tr>
<td><code>/boot</code></td>
<td>fat32</td>
<td>/dev/nvme0n1p1</td>
<td>引导分区 引导进入系统</td>
<td>300MiB</td>
</tr>
</tbody>
</table>
<p>分区命令 <code>cfdisk /dev/nvme0n1</code> 和 <code>cfdisk /dev/sda</code>
格式化命令</p>
<ol>
<li><code>mkfs.fat -F 32 /dev/nvme0n1p1</code></li>
<li><code>mkfs.ext4 /dev/sda6</code></li>
</ol>
<p>开启交换文件(也可以设置交换分区)</p>
<pre><code class="language-shell">dd if=/dev/zero of=/mnt/gentoo/swapfile bs=1M count=8192 status=progress
cd /mnt/gentoo
chmod 600 ./swapfile
mkswap ./swapfile
swapon ./swapfile
swapon --show
</code></pre>
<p>在完成安装后记得检查 <code>/etc/fstab</code></p>
<pre><code class="language-cfg">/swapfile none swap defaults 0 0
</code></pre>
<h4 id="mount">Mount</h4>
<p>依次挂载。
特别地，如果 <code>/dev/nvme0n1p1</code> 带有 windows boot manager，一定要备份！</p>
<pre><code class="language-shell">mkdir --parents /mnt/gentoo/boot
mount /dev/sda6 /mnt/gentoo
mount /dev/nvme0n1p1 /mnt/gentoo/boot
</code></pre>
<h4 id="stage">Stage</h4>
<p>从镜像站中下载一个 stage 包。</p>
<ol>
<li>使用 <code>links</code></li>
<li>使用 <code>lynx</code></li>
<li>wget curl</li>
</ol>
<p>推荐地址 <a href="https://mirrors.tuna.tsinghua.edu.cn/gentoo/releases/amd64/autobuilds/">https://mirrors.tuna.tsinghua.edu.cn/gentoo/releases/amd64/autobuilds/</a></p>
<pre><code class="language-shell">tar xpvf stage3-*.tar.xz --xattrs-include='*.*' --numeric-owner
</code></pre>
<p>说明：</p>
<ol>
<li>xattrs: 开启扩展属性支持。</li>
<li>xattrs-include: 通过规则（通常是正则表达式的方式）指定需要开启扩展属性支持的文件。</li>
</ol>
<h2 id="optimize">Optimize</h2>
<p>Gentoo 需要指定编译参数，合适的优化能带来更强的使用体验。</p>
<p>由于篇幅有限，不可能介绍所有的优化选项；特别地，优化标志不是越多越好，激进的在系统范围上使用的优化标志会伤害应用程序，因此三思而后行。</p>
<p>有关 <code>make.conf</code> 的全部内容可以通过 <code>man 5 make.conf</code> 查找，这里仅介绍一些比较常用的配置。</p>
<p>输入 <code>vim /mnt/gentoo/etc/portage/make.conf</code></p>
<pre><code class="language-cfg"># 为所有语言设置编译标志
COMMON_FLAGS=&quot;-march=native -O2 -pipe&quot;
# 为两个变量使用相同的设置
CFLAGS=&quot;${COMMON_FLAGS}&quot;
CXXFLAGS=&quot;${COMMON_FLAGS}&quot;
</code></pre>
<h3 id="common-flags">COMMON_FLAGS</h3>
<ol>
<li><code>-march=native</code> CPU 指令集
<ul>
<li>不同的 CPU 支持不同的指令集，执行代码的方式也不相同。</li>
<li>该选项指明了编译器应该为系统的处理器架构生成何种代码。</li>
<li>通过 <code>gcc -c -Q -march=native --help=target</code> 或 <code>cat /proc/cpuinfo</code> 返回的结果填写本机需要的处理器架构，也可以直接使用默认值 <code>-march=native</code></li>
</ul>
</li>
<li>-O2
该选项指明的 gcc 的优化级别标志，每提高一个优化等级都将激活大量的优化标志。主要有以下等级：
<ol>
<li><code>-O0</code> 完全关闭优化
不启用优化将导致某些程序无法正常工作，仅调试</li>
<li><code>-O1</code> 最基本的优化</li>
<li><code>-O2</code> 推荐的优化级别
推荐在系统范围内开启此项优化，并开启 <code>-O3</code> 中一些比较安全的选项。</li>
<li><code>-O3</code> 可能的最高优化级别
<ol>
<li>特别需要注意，提高优化级别并不意味着性能一定随之提高，事实上过高的优化将导致汇编语言完全不可执行，从而使程序无法正常运行。</li>
<li>高优化级别将占用大量的内存。</li>
</ol>
</li>
<li><code>-Os</code> 优化代码大小
基于 <code>-O2</code> 且激活了在该级别上不会增加代码生成大小的选项，在小磁盘或小缓存机器上使用。</li>
<li><code>-Og</code> 该选项是在 <code>-O0</code> 的级别上进行的优化
一般用于快速编译和调试，提供合理水平的运行时性能，禁用了可能干扰调试的优化</li>
<li><code>-Ofast</code> 基于 <code>-O3</code> 并增加了额外的优化选项
此优化等级违反了严格的标准合规性，不建议使用。</li>
<li><code>-O4?</code>
现实是高于 3 的级别没有效果，编译器可以接受这些标志，但实际上没有做 <code>-O3</code> 以外的任何事情。</li>
</ol>
</li>
<li>-pipe
该选项用于提高编译速度，在编译的不同阶段使用管道而不是临时文件，代价是占用更多的内存。如果内存小于 4GB (当然小于 4GB 不推荐使用 gentoo)应当关闭该选项。</li>
<li>-fomit-frame-pointer
该选项将不把 <code>frame pointer</code> （栈帧指针）保存在寄存器中，旨在减少生成的代码大小。使用该选项将会使程序调试变得困难或几乎不可能。
该选项在 <code>-O2</code> 时开启。</li>
<li>-finline-functions
允许编译器选择某些简单的函数在其被调用处展开，比较安全的选项，特别是在 CPU 二级缓存较大时建议使用。
该选项在 <code>-O3</code> 时开启。</li>
<li>-funswitch-loops
将循环体中不改变值的变量移动到循环体之外。该选项可能导致问题。
该选项在 <code>-O3</code> 时开启。</li>
<li>-fgcse-after-reload
为了清除多余的溢出，在重载之后执行一个额外的载入消除步骤。
该选项在 <code>-O3</code> 时开启。</li>
<li>-fgraphite-identity
该选项可开启 gcc 编译时的 Graphite 优化，而且不会干扰 gcc 本身在编译程序时的优化判断。建议开启。
开启条件：在 <code>use</code> 中指定 <code>graphite</code> 后重新编译 <code>gcc</code></li>
<li>-floop-nest-optimize
启用基于 isl 的循环嵌套优化器。这是一个基于 Pluto 优化算法的通用循环嵌套优化器。它计算针对数据局部性和并行性优化的循环结构。
<strong>这个选项是实验性的。</strong></li>
<li>-fno-math-errno
任何 <code>-O</code> 选项都不会启用此选项，因为它可能导致依赖于 IEEE 或 ISO 数学函数规则/规范的精确实现的程序输出不正确。
然而，对于不需要这些规范保证的程序，它可能会产生更快的代码。</li>
<li>-fno-trapping-math
假设浮点运算不生成用户可见的陷阱的情况下编译代码。这些陷阱包括除零、溢出、下溢、不精确结果和无效操作。
此选项要求 <code>-fno</code> 信号 NAN 有效。例如，如果依赖于“不间断”的 IEEE 算法，设置此选项可能允许更快的代码。
任何 <code>-O</code> 选项都不应启用此选项，因为它可能会导致依赖于 IEEE 或 ISO 数学函数规则/规范的精确实现的程序输出错误。</li>
<li>-fno-align-functions
通过设置 <strong>函数不对齐</strong> 提高编译速度。
函数对齐是指将函数的开头与大于或等于 n 的下一个二次幂对齐，最多跳过 m-1 个字节，以确保 CPU 至少可以获取函数的前 m 个字节，而不会越过 n 字节对齐边界。</li>
<li>-fno-align-loops
通过设置 <strong>循环不对齐</strong> 提高编译速度。
循环对齐是指将循环对齐到二次幂边界。</li>
<li>-fno-align-jumps
通过设置 <strong>跳跃时循环不对齐</strong> 提高编译速度。
跳跃时循环对齐是指将分支目标与二次方边界对齐，用于只能通过跳跃到达目标的分支目标。</li>
<li>-fno-align-labels
通过设置 <strong>标签不对齐</strong> 提高编译速度。
标签对齐是指将所有分支目标对齐到二次幂边界。</li>
<li>-fno-stack-protector
禁用 <strong>堆栈保护检查</strong> 以提高编译速度。这是以牺牲程序安全性为代价换取性能的设置。与 <code>use=&quot;-ssp&quot;</code> 配合使用。
堆栈保护检查是生成额外的代码来检查缓冲区溢出，例如堆栈粉碎攻击等。
该选项在 gcc 手册上仅解释了非 no 选项，默认开启。</li>
<li>-fno-semantic-interposition
禁用 <strong>动态链接器插入符号</strong> ，以使得编译器能够执行过程间传播、内联和其他优化。
该选项在 gcc 手册上仅解释了非 no 选项，默认不开启。</li>
<li>-fno-common
要求编译器直接为变量分配空间。
-fcommon
要求编译器将变量放置在“公共”存储中。</li>
<li>-fipa-pta
进行过程间指针分析和过程间修改和参考分析。
此选项可能会导致在大型编译单元上使用过多的内存和编译用时。
因此默认情况下，它在任何优化级别都不会启用。</li>
<li>-fno-plt
不要将 PLT 用于与位置无关的代码中的外部函数调用。
此选项可能会导致生成更高效的代码，但也有可能导致编译出错。</li>
</ol>
<h3 id="other-flags">Other FLAGS</h3>
<ol>
<li>
<p>RUST_FLAGS
使用 <code>-C</code> 向 Rust 传递编译优化选项</p>
<pre><code class="language-cfg">RUST_FLAGS=&quot;-C opt-level=2 -C target-cpu=skylake&quot;
</code></pre>
</li>
<li>
<p>LD_FLAGS
使用 <code>-Wl,</code> 向链接器传递选项</p>
<pre><code class="language-cfg">LDFLAGS=&quot;-Wl,-O2 -Wl,--as-needed -Wl,--hash-style=gnu -Wl,--sort-common -Wl,--strip-all&quot;
</code></pre>
<ol>
<li>
<p>&ndash;as-needed
链接器会检查所有的依赖库，没有实际被引用的库，不写入可执行文件头。</p>
</li>
<li>
<p>&ndash;hash-style=gnu</p>
<ul>
<li>设置链接器哈希表的类型。默认是 <code>sysv</code> ，可以设置成 <code>gnu</code> ，也可以设置成 <code>both</code> 。</li>
<li><code>DT_HASH</code> 是 <code>ELF</code> (Linux 可执行程序的文件类型)中的一个 sections，保存了用于查找符号的散列表，以支持符号表的访问，提高符号的搜索速度。</li>
<li><code>gnu.hash</code> 提​供了​与 hash 段​相​同​的​功​能​；但​是与 hash 相比，增加了某些限制（附加规则），​带​来​了​ 50% 的​动​态​链​接​性​能​提​升，代价是不兼容。</li>
</ul>
</li>
<li>
<p>&ndash;sort-common
把全局公共符号按照大小排序后放到适当的输出节，以防止符号间因为排布限制而出现间隙。</p>
</li>
<li>
<p>&ndash;strip-all
从输出文件中忽略所有符号信息。</p>
</li>
<li>
<p>&ndash;static
不链接共享库（推迟到运行时）以提高链接速度，降低运行速度。</p>
</li>
<li>
<p>可以选用其他链接器如 <code>lld</code> 或 <code>gold</code> 替代默认的 <code>bfd</code> 链接器，这可以适当加快链接速度。</p>
<p>但是这样做可能导致在编译大型程序或底层程序时出错，例如 <code>gcc</code> ， <code>glibc</code> ， <code>webkit</code> ， <code>qtwebengine</code></p>
<p>设置方法：</p>
<pre><code class="language-shell">emerge -av lld
LD_FLAGS=&quot;-fuse-ld=lld&quot;
LD=/usr/bin/lld
</code></pre>
</li>
<li>
<p>&ndash;export-dynamic
此标志告诉链接器将所有符号添加到动态符号表中。</p>
</li>
<li>
<p>&ndash;whole-archive
将在其后面出现的静态库包含的函数和变量输出到动态库中。这通常用于将存档文件转换为共享库，强制将每个对象包含在生成的共享库中。</p>
</li>
<li>
<p>-ljemalloc
特别不推荐在全局范围内使用 <code>-ljemalloc</code> （需要额外安装 <code>jemalloc</code> ),可能导致问题。</p>
</li>
</ol>
</li>
<li>
<p>MAKEOPTS
该选项设置并行编译的数量。</p>
<ol>
<li><code>-jX</code> 指代并行编译的数量
建议每个 job 至少有 2 GiB RAM （所以 8 GiB 内存最多设置 <code>-j4</code> ）。
避免内存溢出，根据可用内存降低 job 数量；如果内存足够，那么设置值一般在 <code>CPUs+1</code> 到 <code>2*CPUs+1</code> 之间。</li>
<li><code>-lX</code> 指代平均并行编译的数量（保证不会超载）</li>
</ol>
</li>
<li>
<p>GENTOO_MIRRORS
设置 gentoo 源。</p>
<pre><code class="language-cfg">GENTOO_MIRRORS=&quot;https://mirrors.ustc.edu.cn/gentoo https://mirrors.tuna.tsinghua.edu.cn/gentoo&quot;
</code></pre>
<p>注意 gentoo 源不是必须的，因为 gentoo portage 源提供的 <code>ebuild</code> 会指示软件源码的下载地址。
但是仍然推荐加入 gentoo 源，以缓解上游镜像仓库的压力，同时也能加快关键软件源码下载的速度。</p>
</li>
<li>
<p>USE</p>
<ol>
<li>
<p>如何知道一个软件包有哪些 use 选项？</p>
<pre><code class="language-shell">emerge -av app-portage/gentoolkit
</code></pre>
</li>
<li>
<p>lto pgo graphite
为编译器开启三项优化
特别地，为了防止在全局开启上述优化选项导致程序不可用，将该部分单独配置。
输入 <code>vim /etc/portage/package.use/gcc</code> 并输入以下内容，注意后面几项是可选的。</p>
<pre><code class="language-cfg">sys-devel/gcc lto pgo graphite objc objc++ valgrind -ssp
emerge -av gcc
</code></pre>
</li>
<li>
<p>X xorg
在编译软件时增加 <code>X</code> 和 <code>xorg</code> 支持，如果使用 <code>xorg</code> 环境建议全局开启。</p>
</li>
<li>
<p>wayland
在编译软件时增加 <code>wayland</code> 支持，该项可以不开启。</p>
</li>
<li>
<p>其他可选项</p>
<ol>
<li>最小化推荐的选项 <code>use=&quot;systemd dbus&quot;</code></li>
<li>窗口管理器推荐的选项 <code>use=&quot;alsa pulseaudio policykit&quot;</code></li>
<li>桌面环境推荐的选项 <code>use=&quot;udev kde gnome gtk qt4 qt5&quot;</code></li>
<li>使用文件管理器 <code>use=&quot;udisks archive&quot;</code></li>
<li>图形渲染器 <code>use=&quot;gles2 opengl glx vulkan nvidia&quot;</code></li>
<li>中文支持 <code>use=&quot;cjk&quot;</code></li>
<li>音视频可选支持 <code>use=&quot;ffmpeg&quot;</code></li>
<li>远程登录可选支持 <code>use=&quot;openssl&quot;</code></li>
<li>禁用复杂密码策略 <code>use=&quot;-passwdqc&quot;</code></li>
</ol>
</li>
<li>
<p>查看全局 USE 选项</p>
<pre><code class="language-shell">emerge --info | grep ^USE
</code></pre>
</li>
</ol>
</li>
<li>
<p>ACCEPT_KEYWORDS
一般支持的是 <code>amd64</code> ，更加激进的选项是 <code>~amd64</code> 。
注意后者表示软件版本尚未接受稳定性测试或软件表现不稳定。</p>
</li>
<li>
<p>ACCEPT_LICENSE
设置支持的开源协议。可以根据其授权协议接受或拒绝安装软件。
设置成 <code>ACCEPT_LICENSE=&quot;*&quot;</code> ，会少很多麻烦。</p>
</li>
<li>
<p>GRUB_PLATFORMS
如果使用 GRUB ，那么可以设置成 <code>GRUB_PLATFORMS=efi-64</code></p>
</li>
<li>
<p>EMERGE_DEFAULT_OPTS
为 emerge 加入默认选项，这样就不必每次输入命令的时候都加入这些选项。</p>
<ol>
<li>&ndash;keep-going
即使某一个软件或软件依赖安装出错，也尽可能向下执行（以继续安装其他软件或该软件的其他依赖）</li>
<li>&ndash;with-bdeps &lt;y|n&gt;
在依赖项计算中，引入不严格要求的构建时依赖项</li>
<li>&ndash;jobs &ndash;load-average
这些选项与 <strong>MAKEOPTS</strong> 同时使用时，有效的 job 数量可以指数式加速</li>
</ol>
</li>
<li>
<p>L10N
指示计算机的语言支持。</p>
<pre><code class="language-cfg">L10N=&quot;en-US zh-CN en zh&quot;
</code></pre>
</li>
<li>
<p>VIDEO_CARDS
指示计算机的显卡支持。例如 UHD Graphics 630 属于 Gen8-Gen9。<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></p>
<pre><code class="language-cfg">VIDEO_CARDS=&quot;intel nvidia&quot;
</code></pre>
</li>
<li>
<p>ALSA_CARDS
指示计算机的声卡支持。</p>
<pre><code class="language-cfg">ALSA_CARDS=&quot;hda-intel&quot;
</code></pre>
</li>
<li>
<p>INPUT_DEVICES
指示计算机的输入设备支持。</p>
<pre><code class="language-cfg">INPUT_DEVICES=&quot;libinput synaptics&quot;
</code></pre>
</li>
<li>
<p>LLVM_TARGETS
如果你不知道 <code>LLVM</code> 是什么，那么略过此步骤。</p>
<pre><code class="language-cfg">LLVM_TARGETS=&quot;X86 NVPTX&quot; #nvidia可开启NVPTX而A卡可开启AMDGPU
</code></pre>
</li>
<li>
<p>ABI_X86
如果不知道 <code>wine-staging</code> 和 <code>lutris</code> ，那么略过此步骤。</p>
<pre><code class="language-cfg">ABI_X86=&quot;64 32&quot;
</code></pre>
</li>
<li>
<p>FEATURES
仅介绍 <code>ccache</code> ，用于编译时出现错误或意外中断，下次编译时 ccache 可以直接命中缓存，节约编译时间。
在安装 <code>emerge -av dev-util/ccache</code> 之前不要加入下列内容。</p>
<pre><code class="language-cfg">FEATURES=&quot;ccache&quot;
CCACHE_DIR=&quot;/var/cache/ccache&quot;
</code></pre>
<p>修改文件夹的属主和权限</p>
<pre><code class="language-shell">mkdir -p /var/cache/ccache
chown -R root:portage /var/cache/ccache
chmod -R 2775 /var/cache/ccache
</code></pre>
<p>作一些基本配置，具体可参见 wiki 上的描述<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>。
<code>vim /var/cache/ccache/ccache.conf</code></p>
<pre><code class="language-cfg">max_size = 2G
umask = 002
cache_dir_depth = 3
</code></pre>
</li>
<li>
<p>CPU_FLAGS_X86
可以在这里直接加入计算机 CPU 的指令集，以达到优化的目的。
需要先安装软件包 <code>cpuid2cpuflags</code> ，输入命令： <code>emerge --ask app-portage/cpuid2cpuflags</code>
执行 <code>cpuid2cpuflags</code> ，将获得的 CPU 指令集填写到 <code>make.conf</code> 中。</p>
</li>
</ol>
<p>一切都修改完成，完成 chroot 且同步软件仓库后：</p>
<ol>
<li>重装 <code>gcc</code>
也可以额外装 <code>gcc</code> 版本</li>
<li>下载一个编辑器
比如说 <code>vim</code> 或 <code>neovim</code> 或 <code>emacs</code> ，否则就等着 <code>chroot</code> 之后用 <code>nano</code></li>
</ol>
<h2 id="chroot">Chroot</h2>
<h3 id="software-source">Software Source</h3>
<p>建立软件源文件夹并拷贝默认配置。</p>
<pre><code class="language-shell">mkdir --parents /mnt/gentoo/etc/portage/repos.conf
cp /mnt/gentoo/usr/share/portage/config/repos.conf /mnt/gentoo/etc/portage/repos.conf/gentoo.conf
</code></pre>
<p>注意同步方式的区别：</p>
<ol>
<li>
<p>rsync</p>
<ol>
<li>rsync 是文件同步程序，能够高效地进行文件传输和目录同步。</li>
<li>默认在新安装的 Gentoo 系统上开启，可开启 <code>rsyncd</code> 守护进程。</li>
<li>rsync 的缺点是同步时镜像服务器压力较大，而且自建的 overlay 通过 rsync 部署较困难。</li>
<li>特别地，如果重建 glibc 后 rsync 停止工作，需要重建 rsync</li>
</ol>
<!--listend-->
<pre><code class="language-shell">emerge -av --oneshot net-misc/rsync
</code></pre>
</li>
<li>
<p>git</p>
<ol>
<li>git 是 overlay 的主流同步方式。</li>
<li>同步过程中可以记录提交历史，有助于在软件遇到问题时及时回退软件仓库。</li>
<li>由于 github/gitlab 等网站可便捷地提供 git 远程服务，因此 git 同步是自建 overlay 的主流同步方式。</li>
<li>由于记录了较多的提交历史，在使用一段时间后 git 仓库会变的特别大，而且提交历史大部分对用户是无价值的。</li>
</ol>
</li>
</ol>
<p>首先用 rsync 同步 Gentoo Portage 源的 Gentoo Overlay
编辑 <code>vim /etc/portage/repos.conf/gentoo.conf</code>
关于该文件，可以 <code>man portage</code> 查找配置选项。</p>
<pre><code class="language-cfg">[DEFAULT]
main-repo = gentoo

[gentoo]
location = /var/db/repos/gentoo
sync-type = rsync
sync-uri = rsync://rsync.gentoo.org/gentoo-portage
auto-sync = yes
sync-depth = 2
</code></pre>
<p><strong>在同步软件仓库之后</strong> 可以下载 git。
如需使用 git 同步，删除 <code>/var/db/repos/gentoo</code> 然后将同步方式改为 git 重新同步。
特别地，同步软件仓库需要在挂载和 chroot 之后进行。</p>
<pre><code class="language-cfg">sync-type = git
sync-uri = https://mirrors.tuna.tsinghua.edu.cn/git/gentoo-portage.git
</code></pre>
<h3 id="dns">DNS</h3>
<pre><code class="language-shell">cp --dereference /etc/resolv.conf /mnt/gentoo/etc/
</code></pre>
<p><code>--dereference</code> 保证复制的是真正的文件内容而不是符号链接。
事实上我的电脑只添加了 <code>nameserver 192.168.1.1</code></p>
<h3 id="mount">Mount</h3>
<pre><code class="language-shell">mount --types=proc /proc /mnt/gentoo/proc
mount --rbind /sys /mnt/gentoo/sys
mount --rbind /dev /mnt/gentoo/dev
mount --bind /run /mnt/gentoo/run
mount --make-rslave /mnt/gentoo/sys
mount --make-rslave /mnt/gentoo/dev
mount --make-slave /mnt/gentoo/run
mount --types tmpfs --options nosuid,nodev,noexec shm /dev/shm
chmod 1777 /dev/shm /run/shm
</code></pre>
<p>说明：</p>
<ol>
<li>
<p>mount &ndash;types</p>
<ul>
<li>提供的文件系统可以在 <code>/proc/filesystems</code> 和 <code>/lib/modules/$(uname -r)/kernel/fs</code> 中找到。</li>
<li>一般来说提供下列文件系统: ext2 ext3 ext4 xfs btrfs vfat sysfs proc nfs cifs</li>
<li>我理解的需要通过文件系统来绑定 <code>/proc</code> 的原因：</li>
</ul>
<p><code>/proc</code> 是内核暴露信息的位置，stage3 安装的内核和 livecd 中的内核不同，如果采用绑定方式，则后续无法从 <code>/proc</code> 中获取到当前内核的信息。</p>
</li>
<li>
<p>mount &ndash;bind</p>
<ul>
<li>bind 是绑定，即从 livecd 中将指定的文件绑定到指定位置</li>
<li>可从用户层面理解为硬链接，但原理不同，首先链接关系存在于内存（即临时的），其次被挂载的位置的下级目录将被暂时隐藏</li>
<li>mount &ndash;bind 仅绑定一级目录</li>
<li>mount &ndash;rbind 可以递归的绑定子目录(r for recursive)</li>
<li>我理解的绑定方式不同的原因
<ol>
<li><code>/run</code> 是临时文件系统，用于启动系统的守护进程并存储系统的临时运行时文件，livecd 系统和后续安装的系统的运行时文件可能不同</li>
<li><code>/dev</code> 和 <code>/sys</code> 包含的是系统信息（如设备文件等等），通常这些信息不会发生变化，因此直接递归绑定</li>
</ol>
</li>
</ul>
</li>
<li>
<p>mount &ndash;make-slave 是设置从属挂载；&ndash;make-rslave 是设置递归从属挂载</p>
<ul>
<li>目前支持标记挂载及其子装载为共享、私有、从属或不可绑定。</li>
<li>共享挂载提供了创建该挂载的镜像的能力，例如在任何镜像中的装载和卸载将传播到另一个镜像。</li>
<li>从属挂载即从其主挂载中接收传播的动作，但反过来不行。</li>
<li>私有挂载不携带传播能力。</li>
<li>不可绑定的挂载是专用挂载，它不能通过绑定操作克隆。</li>
</ul>
</li>
</ol>
<!--listend-->
<pre><code class="language-shell">chroot /mnt/gentoo /bin/bash
source /etc/profile #这是最重要的一步
export PS1=&quot;(chroot) ${PS1}&quot;
</code></pre>
<h2 id="portage">Portage</h2>
<h3 id="update-portage-datebase">Update portage datebase</h3>
<p>在本步进行之后才可进行 <strong>安装任何软件</strong> 的操作。</p>
<pre><code class="language-shell">emerge-webrsync #速度快，rsync
emerge --sync #更新更新
</code></pre>
<h3 id="read-news">Read News</h3>
<pre><code class="language-shell">eselect news list
eselect news read
eselect news purge
</code></pre>
<h3 id="select-profile">Select Profile</h3>
<p>推荐使用 desktop profile，注意应和选择的 init 系统保持一致。
当然也可以使用最小化的 profile，这就意味着需要自己处理很多 use 选项和软件问题。</p>
<pre><code class="language-shell">eselect profile list
eselect profile set X #选择恰当的profile
</code></pre>
<h3 id="software-source">Software source</h3>
<p>gentoo 提供软件安装的仓库 overlay，如果需要添加某些软件，应当先将其所在的 overlay 添加到本地。</p>
<p>官方建议选用的添加软件仓库的工具是 eselect-repository，而 layman 目前不被建议使用。</p>
<p>建议添加的 overlay: <code>gentoo-zh</code> <code>guru</code> <code>benzene-overlay</code></p>
<pre><code class="language-shell">emerge -av dev-vcs/git app-eselect/eselect-repository doas sudo
eselect repository list
eselect repository enable X
emerge --sync gentoo-zh
</code></pre>
<h3 id="upgrade-system">Upgrade System</h3>
<p>在更新系统之前，可考虑是否需要从 stage1 开始重建至 stage3。（见下节）</p>
<pre><code class="language-shell">emerge --ask --verbose --update --deep --newuse @world
emerge -avuDN @world
</code></pre>
<p>在以后每次更新系统都可以使用上面的命令，也可以用下面的命令</p>
<pre><code class="language-shell">emerge --ask --verbose --update --deep --changed-use @world
emerge -avuDU @world
</code></pre>
<p>区别：</p>
<ol>
<li>newuse 检查包括当前系统使用的所有 use 选项以及 ebuild 文件中 use 选项的变化，而后对所有变动项所在的软件进行安装</li>
<li>changed-use 检查当前系统使用的所有 use 选项的变化，对变动项所在的软件进行安装。</li>
</ol>
<p>每次运行完更新之后，推荐运行</p>
<pre><code class="language-shell">emerge --depclean
emerge --ask --verbose --emptytree --with-bdeps=y @world
</code></pre>
<h3 id="systemd">Systemd</h3>
<pre><code class="language-shell">ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
vim /etc/locale.gen
locale-gen
eselect locale list
eselect locale set X
env-update &amp;&amp; source /etc/profile &amp;&amp; export PS1=&quot;(chroot) ${PS1}&quot;
</code></pre>
<h2 id="bootstrap">BootStrap</h2>
<p><strong>特别注意，本部分是可选的，供参阅。</strong>
本部分用于从头开始构建所有的内容，类似 <code>linux from stratch</code> 这可能需要相当长的一段时间。整个过程的重点是 <strong>保证二进制文件的完整性</strong> 。</p>
<h3 id="stage">stage</h3>
<ol>
<li>stage 1
<ol>
<li>从第 1 阶段的 tarball 开始，必须使用现有的（二进制）主机系统工具链；</li>
<li>在/var/db/repos/gentoo/scripts/bootstrap.sh 脚本的指导下构建基本工具链（GCC、标准 C 库等）这会产生：</li>
</ol>
</li>
<li>stage 2
在这里，需要使用新工具链来构建（构建）核心@world 包集。这会产生：</li>
<li>stage 3
<ol>
<li>其中工具链已被引导，重要的系统二进制文件和库已使用它编译。</li>
<li>现在，Gentoo 发行版的默认部分提供了这样一个 stage 3 系统目录的 tarball（stage 1 和 stage 2 tarball 不再可供最终用户使用）。</li>
</ol>
</li>
</ol>
<h3 id="stage1-to-stage2">stage1 to stage2</h3>
<p>切换到 bootstrap 目录，然后进行虚拟运行以查看提供的 bootstrap.sh 脚本将要做什么。</p>
<pre><code class="language-shell">eselect locale set X #必须设置成C
cd /var/db/repos/gentoo/scripts
./bootstrap.sh --pretend
</code></pre>
<p>目前 <code>bootstrap.sh</code> 的问题在于：</p>
<ol>
<li>
<p>将要重建的 <code>libc</code> 属于虚拟包</p>
<ol>
<li>虚拟包即本身无任何内容，但是依赖其他包，安装虚拟包事实上就是安装其所依赖的包</li>
<li>重建虚拟包将不会对已安装的被实际依赖的包做任何操作</li>
<li>为了重建已安装的被实际依赖的包做如下操作
<pre><code class="language-cfg">-[[ -z ${ myLIBC } ]]  &amp;&amp;  myLIBC = &quot; $( portageq expand_virtual / virtual/libc ) &quot;
+[[ -z ${ myLIBC } ]]  ;  myLIBC = &quot; $( portageq expand_virtual / virtual/libc ) &quot;
</code></pre>
去掉&amp;&amp;使得以下语句无条件执行，加入分号使得其他部分不受影响。</li>
</ol>
</li>
<li>
<p>将要重建的 <code>gcc</code> 应当具有现代特征 <code>openmp</code></p>
<pre><code class="language-cfg">export USE=&quot;-* bootstrap ${ALLOWED_USE} ${BOOTSTRAP_USE} openmp&quot;
</code></pre>
</li>
<li>
<p><code>!!! CONFIG_PROTECT is empty</code> 警告说，如果要安装的任何包试图覆盖它们，引导过程将不会保留可能已修改的任何配置文件。
这主要包括两个文件 <code>/etc/locale.gen</code> 和 <code>/etc/conf.d/keymap</code> (如果有的话）</p>
<pre><code class="language-shell">cp -v /etc/locale.gen{,.bak}
</code></pre>
</li>
</ol>
<p>说明：由于 <code>bootstrap.sh</code> 文件作为 Gentoo ebuild 主存储库的一部分存在，因此任何更改将在下次同步时被覆盖。然而因为我们现在只想重建我们的系统，所以这不是问题（但你当然可以在此时复制修改后的 bootstrap.sh 文件，如果你愿意的话。</p>
<p>一切就绪，开始执行 <code>./bootstrap.sh</code> 该命令将重建 <code>portage</code> ，如果没有报错，将重建 <code>gcc</code> 和 <code>zlib</code> 等。</p>
<p>若未重建 <code>gcc</code> ，根据警告提示补全当前系统里缺少的 use 选项：
特别地，对 gcc 的 use 选项在 <code>/etc/portage/package.use/gcc</code> 中单独修改。</p>
<p>然后重建整个交叉编译工具链（即 bootstrap 中提示需要安装的软件）。</p>
<p>若已重建 <code>gcc</code> ，检查 <code>gcc</code> 的配置，验证是否重建 <code>gcc</code></p>
<pre><code class="language-shell">gcc-config --list-profiles
</code></pre>
<p>如果这一步提示当前配置无效，执行下面的命令：</p>
<pre><code class="language-shell">gcc-config 1
env-update &amp;&amp; source /etc/profile &amp;&amp; export PS1=&quot;(chroot) $PS1&quot;
</code></pre>
<p>上一步的环境更新完成后，手动重建交叉编译工具链，结束后重新运行一次检测</p>
<pre><code class="language-shell">emerge -av --oneshot sys-devel/libtool binutils llvm clang libc glibc
./bootstrap.sh
</code></pre>
<h3 id="stage2-to-stage3">stage2 to stage3</h3>
<p>当上一阶段提示系统已经成功 <code>bootstraped</code> 后，执行下面的命令</p>
<pre><code class="language-shell">emerge -e @system
emerge -avuDN @world
</code></pre>
<p>所有的工作做完之后，还原文件</p>
<pre><code class="language-shell">mv -v /etc/locale.gen{.bak,}
locale-gen
eselect locale list
eselect locale set X
</code></pre>
<h2 id="kernel">Kernel</h2>
<h3 id="firmeware">firmeware</h3>
<p>相当多的设备需要先在系统上安装附加的固件才能正常运行，因此 <code>sys-kernel/linux-firmware</code> 几乎是必须的。
另外可能还需要安装微码(为 CPU 提供的固件更新)，因此 <code>sys-firmware/intel-microcode</code> 需要安装（AMD 的微码包含在固件中）。</p>
<h3 id="kernel">kernel</h3>
<p>gentoo-source
genkernel initramfs
vanill-kernel
xanmod-kernel
我强烈推荐第一次安装的 Linux 爱好者 <strong>先装二进制内核</strong> ，原因如下：</p>
<ol>
<li>
<p>如果你第一次配置自己的内核，你可能将它弄的一团糟；</p>
</li>
<li>
<p>如果在 1 小时，1天甚至一周的时间内你仍然没有获得一个可用的内核，你的信心会受到巨大的打击；</p>
</li>
<li>
<p>如果在新系统上有某些功能不可用，你无法排除是否属于内核的原因。</p>
<p><code>vim /etc/portage/package.use/kernel</code>
sys-kernel/gentoo-kernel-bin -initramfs</p>
</li>
</ol>
<!--listend-->
<pre><code class="language-shell">emerge -av sys-kernel/gentoo-kernel-bin
</code></pre>
<p>尽管你可能不知道如何配置内核，但是如果你想体验一下如何编译它，具体的配置选用官方定义好的版本，这是可以的：</p>
<pre><code class="language-shell">emerge -av sys-kernel/gentoo-kernel
eselect kernel list
eselect kernel set 1
cd /usr/src/linux
make mrproper #类似 make clean
make -jX &amp;&amp; make -jX modules_install
make install
</code></pre>
<h2 id="system">System</h2>
<h3 id="fstab">fstab</h3>
<p>建议使用 UUID 而不是 Label 定义以确保唯一性。</p>
<pre><code class="language-shell">emerge -av sys-fs/genfstab
genfstab -U / &gt;&gt; /etc/fstab
genfstab -U /mnt/gentoo &gt;&gt; /mnt/gentoo/etc/fstab # arch自带的genfstab从ISO生成可能不行
</code></pre>
<h3 id="hostname">hostname</h3>
<pre><code class="language-shell">hostnamectl hostname LeeSin
echo 'LeeSin' &gt; /etc/hostname
vim /etc/hosts
</code></pre>
<h3 id="network">Network</h3>
<p>介绍两种网络配置办法。</p>
<h4 id="networkmanager">NetworkManager</h4>
<pre><code class="language-shell">emerge -av net-misc/dhcpcd
systemctl enable --now dhcpcd
emerge -av net-misc/networkmanager
</code></pre>
<p>需要为 <code>networkmanager</code> 开启一些 use 选项，否则在后续使用中可能遇到代理等问题。
输入 <code>vim /etc/portage/package.use/network</code></p>
<pre><code class="language-cfg">net-misc/networkmanager concheck dhcpcd gnutls gtk-doc introspection iptables nftables policykit ppp systemd tools wext wifi
</code></pre>
<p>为 <code>networkmanager</code> 安装前端软件，如 <code>nm-applet</code> 等。（KDE 或 gnome 提供了前端组件）</p>
<h4 id="networkd-and-iwd">Networkd &amp; Iwd</h4>
<p>Networkd 适用 systemd 系统。</p>
<pre><code class="language-shell">emerge -av net-wireless/iwd net-misc/dhcpcd
systemctl enable iwd dhcpcd systemd-networkd
</code></pre>
<!--list-separator-->
<ul>
<li>
<p>Networkd</p>
<p>查看以太网接口名称，可用 <code>ip link</code> 或 <code>networkctl list</code> 查看。
输入 <code>vim /etc/systemd/network/20-wired.network</code></p>
<pre><code class="language-shell">[Match]
Name=enp4s0 # 替换为前述命令得到的接口名

[Network]
DHCP=ipv4
</code></pre>
<p>如需配置静态 IP 或者其他高级配置，参见 ArchWiki<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup></p>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>Iwd</p>
<p>输入 <code>iwctl</code> 进入交互式命令行。（退出可用 <code>C-d</code> 发出 <code>EOF</code> 信号）</p>
<ol>
<li>help 查看帮助</li>
<li>device list 列出所有设备</li>
<li>station list 列出所有无线设备</li>
<li>station device scan 扫描网络</li>
<li>station device get-networks 列出可用网络</li>
<li>station device connect SSID 连接指定网络</li>
</ol>
<p>详细内容参阅 ArchWiki<sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup></p>
<p>特别地，若无设备列出，考虑以下原因：</p>
<ol>
<li><code>rfkill list</code> 检查无线设备是否被禁用，若被禁用，~rfkill unlock wifi~ 启用该设备。</li>
<li><code>lspci -k</code> 检查无线设备是否有驱动</li>
</ol>
</li>
</ul>
<h3 id="systemd-setup">Systemd setup</h3>
<p>设置 <code>machine-id</code> 对于使用 <code>systemd-boot</code> 的用户有帮助</p>
<pre><code class="language-shell">systemd-firstboot --prompt --setup-machine-id
systemd preset-all
</code></pre>
<h3 id="sshd">SSHD</h3>
<pre><code class="language-shell">systemctl enable sshd
</code></pre>
<h3 id="time">Time</h3>
<ol>
<li>Linux 将系统时钟视为 UTC，并将当前时间设置为 UTC+8</li>
<li>Windows 则将系统时钟视为 RTC，并将当前时间设置为该时间。</li>
<li>可以设置 Linux 系统使用 RTC 硬件时钟，也可以设置 windows 将硬件时钟视为 UTC</li>
</ol>
<!--listend-->
<pre><code class="language-shell">timedatectl set-rtc true
systemctl enable systemd-timesyncd
</code></pre>
<h3 id="user">User</h3>
<pre><code class="language-shell">passwd
useradd -m -G users,wheel,audio,video -s /bin/bash leesin
passwd leesin
</code></pre>
<h2 id="boot">Boot</h2>
<p>检查一下你的计算机是否有启动引导器，即开机的时候尝试按 ESC 键。如果有启动引导器，事情会好办很多。</p>
<h3 id="grub">Grub</h3>
<pre><code class="language-shell">emerge -av sys-boot/grub
grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=gentoo
grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=gentoo
emerge -av sys-boot/os-prober
</code></pre>
<p>输入 <code>vim /etc/default/grub</code></p>
<pre><code class="language-cfg">GRUB_DISABLE_OS_PROBER=&quot;false&quot;
GRUB_CMDLINE_LINUX=&quot;init=/usr/lib/systemd/systemd loglevel=5 nowatchdog&quot;
# 如果不需要debug,可以启用quiet
# nowatchdog 可以显著提升关机速度
grub-mkconfig -o /boot/grub/grub.cfg
</code></pre>
<h3 id="other">Other</h3>
<ol>
<li>LILO</li>
<li>efibootmgr</li>
<li>systemd-boot</li>
<li>syslinux</li>
</ol>
<h3 id="exit-and-reboot">Exit and Reboot</h3>
<pre><code class="language-shell">exit
cd /
umount -lRv /mnt/gentoo
reboot
rm /stage3-*.tar.*
</code></pre>
<ol>
<li>-l 指的是懒卸载，比较安全</li>
<li>-R 指的是递归卸载</li>
<li>-v 指的是显示卸载内容</li>
</ol>
<h2 id="reference">Reference</h2>
<ol>
<li><a href="https://wiki.gentoo.org/wiki/Handbook:Main_Page/zh-cn/">https://wiki.gentoo.org/wiki/Handbook:Main_Page/zh-cn/</a></li>
<li><a href="https://bitbili.net/gentoo-linux-installation-and-usage-tutorial.html">https://bitbili.net/gentoo-linux-installation-and-usage-tutorial.html</a></li>
<li><a href="https://blog.bugsur.xyz/gentoo-handbook-installation">https://blog.bugsur.xyz/gentoo-handbook-installation</a></li>
<li><a href="https://wiki.gentoo.org/wiki/User:Sakaki/Sakaki%27s_EFI_Install_Guide/Building_the_Gentoo_Base_System_Minus_Kernel">Sakaki Bootstrap</a></li>
</ol>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://wiki.gentoo.org/wiki/Intel">Intel处理器及图形显卡</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p><a href="https://wiki.gentoo.org/wiki/Ccache">Ccache配置</a>&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p><a href="https://wiki.archlinux.org/title/Systemd-networkd">Systemd-networkd 配置</a>&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4">
<p><a href="https://wiki.archlinux.org/title/Iwd">Iwd配置</a>&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

</article>

                    
                    
                    
                    <div class="py-2">
  
    <div class="my-8 flex flex-col items-center md:flex-row">
      <a href="https://endlesspeak.github.io/authors/endlesspeak/" class="md:me-4 text-primary-text h-24 w-24">
        
        
          <img
            src="https://endlesspeak.github.io/images/avtar.png"
            class="bg-primary-bg w-full rounded-full"
            alt="Avatar"
          />
        
      </a>
      <div class="mt-4 w-full md:mt-0 md:w-auto">
        <a
          href="https://endlesspeak.github.io/authors/endlesspeak/"
          class="mb-2 block border-b pb-1 text-lg font-bold"
        >
          <h3>Serene Feather Pavilion</h3>
        </a>
        <span class="block pb-2">瞽者无以与乎文章之观,聋者无以与乎钟鼓之声。岂唯形骸有聋盲哉?</span>
        
          
          
          
          
          <a href="mailto:endlesspeak@163.com" class="me-2">
            <i class="fas fa-envelope"></i>
          </a>
        
          
          
          
          
          <a href="https://gitee.com/endlesspeak" class="me-2">
            <i class="fab fa-git-square"></i>
          </a>
        
          
          
          
          
          <a href="https://github.com/endlesspeak" class="me-2">
            <i class="fab fa-github"></i>
          </a>
        
          
          
          
          
          <a href="https://space.bilibili.com/316071845" class="me-2">
            <i class="fas fa-tv"></i>
          </a>
        
      </div>
    </div>
  
</div>

                    

                    



                    
  <div
    class="-mx-2 mt-4 flex flex-col border-t px-2 pt-4 md:flex-row md:justify-between"
  >
    <div>
      
        <span class="text-primary-text block font-bold"
          >上一页</span
        >
        <a href="https://endlesspeak.github.io/docs/build/operating-system-installation/linux-technology-3-2-arch-linux-installation/" class="block">Arch Linux 物理机的安装与引导</a>
      
    </div>
    <div class="mt-4 md:mt-0 md:text-right">
      
        <span class="text-primary-text block font-bold">下一页</span>
        <a href="https://endlesspeak.github.io/docs/build/operating-system-installation/linux-technology-3-4-nixos-linux-installation/" class="block">NixOS Linux 物理机安装与配置</a>
      
    </div>
  </div>


                    



                </div>
                
                <div class="hidden lg:block lg:w-1/4">
                    
                    <div
  class="
    bg-secondary-bg
   prose sticky top-16 z-10 hidden px-6 py-4 lg:block"
>
  <h3>本页内容</h3>
</div>
<div
  class="sticky-toc 
    border-s
   hidden px-6 pb-6 lg:block"
>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#note">Note</a>
      <ul>
        <li><a href="#motivation">Motivation</a></li>
        <li><a href="#reference-additional">Reference Additional</a></li>
        <li><a href="#requirement">Requirement</a></li>
      </ul>
    </li>
    <li><a href="#start">Start</a>
      <ul>
        <li><a href="#network">Network</a></li>
        <li><a href="#preinstallation">PreInstallation</a></li>
        <li><a href="#partition">Partition</a></li>
      </ul>
    </li>
    <li><a href="#optimize">Optimize</a>
      <ul>
        <li><a href="#common-flags">COMMON_FLAGS</a></li>
        <li><a href="#other-flags">Other FLAGS</a></li>
      </ul>
    </li>
    <li><a href="#chroot">Chroot</a>
      <ul>
        <li><a href="#software-source">Software Source</a></li>
        <li><a href="#dns">DNS</a></li>
        <li><a href="#mount">Mount</a></li>
      </ul>
    </li>
    <li><a href="#portage">Portage</a>
      <ul>
        <li><a href="#update-portage-datebase">Update portage datebase</a></li>
        <li><a href="#read-news">Read News</a></li>
        <li><a href="#select-profile">Select Profile</a></li>
        <li><a href="#software-source">Software source</a></li>
        <li><a href="#upgrade-system">Upgrade System</a></li>
        <li><a href="#systemd">Systemd</a></li>
      </ul>
    </li>
    <li><a href="#bootstrap">BootStrap</a>
      <ul>
        <li><a href="#stage">stage</a></li>
        <li><a href="#stage1-to-stage2">stage1 to stage2</a></li>
        <li><a href="#stage2-to-stage3">stage2 to stage3</a></li>
      </ul>
    </li>
    <li><a href="#kernel">Kernel</a>
      <ul>
        <li><a href="#firmeware">firmeware</a></li>
        <li><a href="#kernel">kernel</a></li>
      </ul>
    </li>
    <li><a href="#system">System</a>
      <ul>
        <li><a href="#fstab">fstab</a></li>
        <li><a href="#hostname">hostname</a></li>
        <li><a href="#network">Network</a></li>
        <li><a href="#systemd-setup">Systemd setup</a></li>
        <li><a href="#sshd">SSHD</a></li>
        <li><a href="#time">Time</a></li>
        <li><a href="#user">User</a></li>
      </ul>
    </li>
    <li><a href="#boot">Boot</a>
      <ul>
        <li><a href="#grub">Grub</a></li>
        <li><a href="#other">Other</a></li>
        <li><a href="#exit-and-reboot">Exit and Reboot</a></li>
      </ul>
    </li>
    <li><a href="#reference">Reference</a></li>
  </ul>
</nav>
</div>
<script>
  window.addEventListener("DOMContentLoaded", () => {
    enableStickyToc();
  });
</script>

                    
                </div>
                
            </div>

        </div>


    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        
        hljs.highlightAll();
        changeSidebarHeight();
        switchDocToc();
    })
</script>









          </div>
        </div>
      
    </main>
    <footer class="pl-scrollbar">
      <div class="mx-auto w-full max-w-screen-2xl"><div class="text-center p-6 pin-b">
    <p class="text-sm text-tertiary-text">&copy; 2021 <a href="https://www.wangchucheng.com/">C. Wang</a> and <a href="https://www.ruiqima.com/">R. Ma</a>
 &middot;  Powered by the <a href="https://github.com/wangchucheng/hugo-eureka" class="hover:text-eureka">Eureka</a> theme for <a href="https://gohugo.io" class="hover:text-eureka">Hugo</a></p>
</div></div>
    </footer>
  </body>
</html>
